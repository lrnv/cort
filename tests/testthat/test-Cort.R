context("Testing the class Cort...")
library(cort)
model = Cort(LifeCycleSavings[,1:3],verbose_lvl = 0)
model2 = quiet(Cort(LifeCycleSavings,verbose_lvl = 10,number_max_dim = 2))
u=matrix(rep(0,15),ncol=5)
v=matrix(seq(0,1,length.out=15),ncol=5)
w=matrix(rep(1,15),ncol=5)

quiet(show(model))
quiet(plot(model))
quiet(pairs(model))

rho = biv_rho(model)
tau = biv_tau(model)

loss = loss(model)
ctr_infl = constraint_infl(model)
qp = quad_prod_with_data(model)

smaller_model = project_on_dims(model,c(1,2))
kendall = kendall_func(model,seq(0,1,length.out=10),M=10)

testthat::test_that("initialisation check of Cort are ok", {
  testthat::expect_error(Cort(LifeCycleSavings,pseudo_data=TRUE,verbose_lvl = 0))
})

testthat::test_that("the quandratic norm is coherent with the quad prod", {
  testthat::expect_equal(quad_prod(model,model),quad_norm(model))
})


testthat::test_that("pCopula values are between 0 and 1 with OK bounds.",{
  testthat::expect_true(all(pCopula(matrix(seq(0.3,1,length.out = 10),nrow=2),model2) >= c(0,0)))
  testthat::expect_true(all(pCopula(matrix(seq(0.3,1,length.out = 10),nrow=2),model2) <= c(1,1)))
  testthat::expect_equal(pCopula(matrix(seq(0,0,length.out = 10),nrow=2),model2),c(0,0))
  testthat::expect_error(pCopula(matrix(seq(0.3,1,length.out = 8),nrow=2),model2))
})

testthat::test_that("dCopula values are between 0 and 1 with OK bounds.",{
  testthat::expect_true(all(dCopula(matrix(seq(0.3,1,length.out = 10),nrow=2),model2) >= c(0,0)))
  testthat::expect_error(dCopula(matrix(seq(0.3,1,length.out = 8),nrow=2),model2))
})

testthat::test_that("vCopula did not change",{
  testthat::expect_equal(vCopula(u,v,model2)[1],0)
  testthat::expect_error(vCopula(v,u,model2))
})

testthat::test_that("dim is ok",{
  testthat::expect_equal(dim(model2),5)
  testthat::expect_equal(dim(model2),5)
})

testthat::test_that("rCopula output is ok for Cort",{
  testthat::expect_equivalent(rCopula(0,model2),matrix(ncol=5,nrow=0))
  testthat::expect_is(rCopula(10,model2),"matrix")
  testthat::expect_equal(ncol(rCopula(10,model2)),dim(model2))
})

testthat::test_that("projection is ok",{
  testthat::expect_equal(dim(smaller_model),2)
})

testthat::test_that("tau works",{
  testthat::expect_equal(dim(tau), c(dim(model),dim(model)))
  testthat::expect_equal(diag(tau), rep(1,dim(model)))
  expect_true(all(tau <= 1) & all(tau >=-1))
  testthat::expect_equal(biv_tau(smaller_model)[2],tau[2])
})

testthat::test_that("rho works",{
  testthat::expect_equal(dim(rho), c(dim(model),dim(model)))
  testthat::expect_equal(diag(rho), rep(1,dim(model)))
  expect_true(all(rho <= 1) & all(rho >=-1))
  testthat::expect_equal(biv_rho(smaller_model)[2],rho[2])
})

set.seed(12)
model = Cort(LifeCycleSavings[,2:4],verbose_lvl=0)
x = list(a = model@a, b = model@b, p = model@p, f = model@f)
x_ref =list(a = structure(c(0, 0, 0.568806693118027, 0.568806693118027,
0, 0, 0.257114047633595, 0.257114047633595, 0, 0.568806693118027,
0.568806693118027, 0.568806693118027, 0.678918072478327, 0.568806693118027,
0.568806693118027, 0.568806693118027, 0.74840180772078, 0.74840180772078,
0.74840180772078, 0.74840180772078, 0.568806693118027, 0, 0,
0, 0.099437396491186, 0.099437396491186, 0.099437396491186, 0.099437396491186,
0, 0, 0, 0.11766626306409, 0.11766626306409, 0.11766626306409,
0, 0.257114047633595, 0.360517029163722, 0.360517029163722, 0.360517029163722,
0.257114047633595, 0.257114047633595, 0.257114047633595, 0.481023129487533,
0.481023129487533, 0.481023129487533, 0.481023129487533, 0.257114047633595,
0.678918072478327, 0.678918072478327, 0.937646113079323, 0.937646113079323,
0.937646113079323, 0.937646113079323, 0.678918072478327, 0.678918072478327,
0.898330001327385, 0.898330001327385, 0.678918072478327, 0.678918072478327,
0.678918072478327, 0.678918072478327, 0.742662819283674, 0.742662819283674,
0.742662819283674, 0.678918072478327, 0.568806693118027, 0.607843137254902,
0.607843137254902, 0.568806693118027, 0, 0, 0, 0.0783518138819067,
0.0783518138819067, 0.0783518138819067, 0.0783518138819067, 0,
0.11766626306409, 0.11766626306409, 0.11766626306409, 0.161660507331838,
0.161660507331838, 0.161660507331838, 0.161660507331838, 0.11766626306409,
0.257114047633595, 0.257114047633595, 0.257114047633595, 0.274512900168399,
0.274512900168399, 0.274512900168399, 0.274512900168399, 0.257114047633595,
0.257114047633595, 0.257114047633595, 0.257114047633595, 0.257114047633595,
0.360517029163722, 0.360517029163722, 0.360517029163722, 0.490192542884614,
0.490192542884614, 0.490192542884614, 0.490192542884614, 0.360517029163722,
0.257114047633595, 0.257114047633595, 0.257114047633595, 0.372979143080572,
0.372979143080572, 0.372979143080572, 0.372979143080572, 0.257114047633595,
0.678918072478327, 0.678918072478327, 0.678918072478327, 0.678918072478327,
0.742662819283674, 0.742662819283674, 0.742662819283674, 0.742662819283674,
0, 0.431415156934078, 0.431415156934078, 0.431415156934078, 0,
0.431415156934078, 0.745058746501665, 0.745058746501665, 0.431415156934078,
0, 0.305160446055449, 0.305160446055449, 0.305160446055449, 0,
0.0980431379036761, 0.0980431379036761, 0, 0, 0.0980431379036761,
0.0980431379036761, 0, 0.745058746501665, 0.886357332856632,
0.886357332856632, 0.745058746501665, 0.745058746501665, 0.886357332856632,
0.886357332856632, 0.745058746501665, 0.873460526946288, 0.873460526946288,
0.745058746501665, 0.745058746501665, 0.873460526946288, 0.745058746501665,
0.549029309836594, 0.431415156934078, 0.549029309836594, 0.549029309836594,
0.431415156934078, 0.666656497083032, 0.666656497083032, 0.431415156934078,
0.431415156934078, 0.666656497083032, 0.666656497083032, 0.431415156934078,
0, 0.0647068637922547, 0, 0, 0.0647068637922547, 0.0647068637922547,
0, 0, 0, 0, 0, 0.305160446055449, 0.317393734234074, 0.317393734234074,
0.305160446055449, 0.305160446055449, 0.317393734234074, 0.305160446055449,
0.176470588235294, 0, 0.176470588235294, 0, 0.745058746501665,
0.796711950657678, 0.796711950657678, 0.745058746501665, 0.745058746501665,
0.796711950657678, 0.796711950657678, 0.745058746501665, 0.873460526946288,
0.963326156790667, 0.963326156790667, 0.873460526946288, 0.873460526946288,
0.963326156790667, 0.963326156790667, 0.873460526946288, 0.431415156934078,
0.525973418251757, 0.525973418251757, 0.431415156934078, 0.431415156934078,
0.525973418251757, 0.525973418251757, 0.431415156934078, 0.549029309836594,
0.590479606410548, 0.590479606410548, 0.549029309836594, 0.431415156934078,
0.531586288223128, 0.531586288223128, 0.431415156934078, 0.431415156934078,
0.531586288223128, 0.531586288223128, 0.431415156934078, 0.431415156934078,
0.627448903014251, 0.627448903014251, 0.431415156934078, 0.431415156934078,
0.627448903014251, 0.627448903014251, 0.431415156934078, 0.0647068637922547,
0.208107436420944, 0.208107436420944, 0.0647068637922547, 0.317393734234074,
0.369309286193406, 0.369309286193406, 0.317393734234074, 0.430971456830474,
0, 0, 0.430971456830474, 0, 0.737816099326337, 0.430971456830474,
0.737816099326337, 0.430971456830474, 0.313719300389237, 0, 0.313719300389237,
0, 0.521179545614887, 0.430971456830474, 0.521179545614887, 0.430971456830474,
0.521179545614887, 0.430971456830474, 0.521179545614887, 0.430971456830474,
0.68626968947982, 0.430971456830474, 0.68626968947982, 0.430971456830474,
0.68626968947982, 0.430971456830474, 0.68626968947982, 0.430971456830474,
0.737816099326337, 0.856213659829922, 0.737816099326337, 0.856213659829922,
0.856213659829922, 0.737816099326337, 0.534511012734333, 0.534511012734333,
0.430971456830474, 0.534511012734333, 0.430971456830474, 0.737816099326337,
0.816772657662425, 0.737816099326337, 0.816772657662425, 0.737816099326337,
0.816772657662425, 0.737816099326337, 0.254897849928683, 0.254897849928683,
0, 0.254897849928683, 0, 0.254897849928683, 0, 0.390717789396181,
0.313719300389237, 0.390717789396181, 0.313719300389237, 0.41176012521525,
0.313719300389237, 0.41176012521525, 0.313719300389237, 0.41176012521525,
0.41176012521525, 0.313719300389237, 0, 0, 0, 0, 0.884888316504669,
0.856213659829922, 0.884888316504669, 0.856213659829922, 0.884888316504669,
0.856213659829922, 0.884888316504669, 0.856213659829922, 0.784320455766265,
0.737816099326337, 0.784320455766265, 0.737816099326337, 0.784320455766265,
0.737816099326337, 0.784320455766265, 0.737816099326337, 0.704356768014974,
0.534511012734333, 0.704356768014974, 0.534511012734333, 0.704356768014974,
0.534511012734333, 0.704356768014974, 0.534511012734333, 0.454697895779299,
0.430971456830474, 0.454697895779299, 0.430971456830474, 0.457479681821354,
0.430971456830474, 0.457479681821354, 0.430971456830474, 0.457479681821354,
0.430971456830474, 0.457479681821354, 0.430971456830474, 0.877074651312449,
0.816772657662425, 0.877074651312449, 0.816772657662425, 0.877074651312449,
0.816772657662425, 0.877074651312449, 0.816772657662425, 0.220221438364761,
0, 0.220221438364761, 0, 0.372525451152003, 0.313719300389237,
0.372525451152003, 0.313719300389237), .Dim = c(121L, 3L), .Dimnames = list(
NULL, NULL)), b = structure(c(0.568806693118027, 0.568806693118027,
1, 1, 0.568806693118027, 0.257114047633595, 0.568806693118027,
0.568806693118027, 0.257114047633595, 0.678918072478327, 0.678918072478327,
0.678918072478327, 1, 0.74840180772078, 0.74840180772078, 0.74840180772078,
1, 1, 1, 1, 0.74840180772078, 0.099437396491186, 0.099437396491186,
0.099437396491186, 0.257114047633595, 0.257114047633595, 0.257114047633595,
0.257114047633595, 0.099437396491186, 0.11766626306409, 0.11766626306409,
0.257114047633595, 0.257114047633595, 0.257114047633595, 0.11766626306409,
0.360517029163722, 0.568806693118027, 0.568806693118027, 0.568806693118027,
0.360517029163722, 0.481023129487533, 0.481023129487533, 0.568806693118027,
0.568806693118027, 0.568806693118027, 0.568806693118027, 0.481023129487533,
0.937646113079323, 0.937646113079323, 1, 1, 1, 1, 0.937646113079323,
0.898330001327385, 1, 1, 0.898330001327385, 0.742662819283674,
0.742662819283674, 0.742662819283674, 1, 1, 1, 0.742662819283674,
0.607843137254902, 0.678918072478327, 0.678918072478327, 0.607843137254902,
0.0783518138819067, 0.0783518138819067, 0.0783518138819067, 0.11766626306409,
0.11766626306409, 0.11766626306409, 0.11766626306409, 0.0783518138819067,
0.161660507331838, 0.161660507331838, 0.161660507331838, 0.257114047633595,
0.257114047633595, 0.257114047633595, 0.257114047633595, 0.161660507331838,
0.274512900168399, 0.274512900168399, 0.274512900168399, 0.360517029163722,
0.360517029163722, 0.360517029163722, 0.360517029163722, 0.274512900168399,
0.360517029163722, 0.360517029163722, 0.360517029163722, 0.360517029163722,
0.490192542884614, 0.490192542884614, 0.490192542884614, 0.568806693118027,
0.568806693118027, 0.568806693118027, 0.568806693118027, 0.490192542884614,
0.372979143080572, 0.372979143080572, 0.372979143080572, 0.481023129487533,
0.481023129487533, 0.481023129487533, 0.481023129487533, 0.372979143080572,
0.937646113079323, 0.937646113079323, 0.937646113079323, 0.937646113079323,
1, 1, 1, 1, 0.431415156934078, 1, 1, 1, 0.431415156934078, 0.745058746501665,
1, 1, 0.745058746501665, 0.305160446055449, 0.431415156934078,
0.431415156934078, 0.431415156934078, 0.0980431379036761, 0.431415156934078,
0.431415156934078, 0.0980431379036761, 0.0980431379036761, 0.431415156934078,
0.431415156934078, 0.0980431379036761, 0.886357332856632, 1,
1, 0.886357332856632, 0.886357332856632, 1, 1, 0.886357332856632,
1, 1, 0.873460526946288, 0.873460526946288, 1, 0.873460526946288,
0.745058746501665, 0.549029309836594, 0.745058746501665, 0.745058746501665,
0.549029309836594, 0.745058746501665, 0.745058746501665, 0.666656497083032,
0.666656497083032, 0.745058746501665, 0.745058746501665, 0.666656497083032,
0.0647068637922547, 0.305160446055449, 0.0647068637922547, 0.0647068637922547,
0.305160446055449, 0.305160446055449, 0.0647068637922547, 0.305160446055449,
0.305160446055449, 0.305160446055449, 0.305160446055449, 0.317393734234074,
0.431415156934078, 0.431415156934078, 0.317393734234074, 0.317393734234074,
0.431415156934078, 0.317393734234074, 0.305160446055449, 0.176470588235294,
0.305160446055449, 0.176470588235294, 0.796711950657678, 0.873460526946288,
0.873460526946288, 0.796711950657678, 0.796711950657678, 0.873460526946288,
0.873460526946288, 0.796711950657678, 0.963326156790667, 1, 1,
0.963326156790667, 0.963326156790667, 1, 1, 0.963326156790667,
0.525973418251757, 0.549029309836594, 0.549029309836594, 0.525973418251757,
0.525973418251757, 0.549029309836594, 0.549029309836594, 0.525973418251757,
0.590479606410548, 0.745058746501665, 0.745058746501665, 0.590479606410548,
0.531586288223128, 0.549029309836594, 0.549029309836594, 0.531586288223128,
0.531586288223128, 0.549029309836594, 0.549029309836594, 0.531586288223128,
0.627448903014251, 0.666656497083032, 0.666656497083032, 0.627448903014251,
0.627448903014251, 0.666656497083032, 0.666656497083032, 0.627448903014251,
0.208107436420944, 0.305160446055449, 0.305160446055449, 0.208107436420944,
0.369309286193406, 0.431415156934078, 0.431415156934078, 0.369309286193406,
1, 0.430971456830474, 0.430971456830474, 1, 0.430971456830474,
1, 0.737816099326337, 1, 0.737816099326337, 0.430971456830474,
0.313719300389237, 0.430971456830474, 0.313719300389237, 1, 0.521179545614887,
1, 0.521179545614887, 1, 0.521179545614887, 1, 0.521179545614887,
0.737816099326337, 0.68626968947982, 0.737816099326337, 0.68626968947982,
0.737816099326337, 0.68626968947982, 0.737816099326337, 0.68626968947982,
0.856213659829922, 1, 0.856213659829922, 1, 1, 0.856213659829922,
0.737816099326337, 0.737816099326337, 0.534511012734333, 0.737816099326337,
0.534511012734333, 0.816772657662425, 1, 0.816772657662425, 1,
0.816772657662425, 1, 0.816772657662425, 0.313719300389237, 0.313719300389237,
0.254897849928683, 0.313719300389237, 0.254897849928683, 0.313719300389237,
0.254897849928683, 0.430971456830474, 0.390717789396181, 0.430971456830474,
0.390717789396181, 0.430971456830474, 0.41176012521525, 0.430971456830474,
0.41176012521525, 0.430971456830474, 0.430971456830474, 0.41176012521525,
0.313719300389237, 0.313719300389237, 0.313719300389237, 0.313719300389237,
1, 0.884888316504669, 1, 0.884888316504669, 1, 0.884888316504669,
1, 0.884888316504669, 0.856213659829922, 0.784320455766265, 0.856213659829922,
0.784320455766265, 0.856213659829922, 0.784320455766265, 0.856213659829922,
0.784320455766265, 0.737816099326337, 0.704356768014974, 0.737816099326337,
0.704356768014974, 0.737816099326337, 0.704356768014974, 0.737816099326337,
0.704356768014974, 0.534511012734333, 0.454697895779299, 0.534511012734333,
0.454697895779299, 0.534511012734333, 0.457479681821354, 0.534511012734333,
0.457479681821354, 0.534511012734333, 0.457479681821354, 0.534511012734333,
0.457479681821354, 1, 0.877074651312449, 1, 0.877074651312449,
1, 0.877074651312449, 1, 0.877074651312449, 0.254897849928683,
0.220221438364761, 0.254897849928683, 0.220221438364761, 0.41176012521525,
0.372525451152003, 0.41176012521525, 0.372525451152003), .Dim = c(121L,
3L), .Dimnames = list(NULL, NULL)), p = c(0.000221849413804122,
0, 0, 1.0142784668087e-09, 0, 2.61858089478651e-09, 0, 0, 0.00207250384165715,
0, 0.00887262449553968, 0, 3.81166379096406e-09, 1.56472046079854e-05,
2.20188030273121e-08, 4.19586189791012e-05, 7.8793703316044e-09,
0, 2.44086514482584e-08, 0.000129361643809187, 3.47535382643493e-05,
0, 0.0063285647537084, 0.00786807925094457, 0.0220416096420068,
0, 0.00668136983861204, 0, 0.0039172502623396, 0.0136265380827274,
0.0126560674959704, 0.017914151900296, 0.0179433615815583, 0.0145739689660038,
2.66181323609383e-10, 0.0186619663250903, 2.2587193423225e-08,
0, 0.113825376418474, 0, 6.22450181236183e-10, 1.15440029341646e-09,
0.00170582718708687, 0, 0.0134672406932297, 3.72234467347342e-10,
0.00105133064668214, 5.19904232433233e-11, 0.0381865046738858,
0.0339432420905557, 8.29583158225539e-12, 0.00560826978859585,
4.02581030693651e-11, 0.00924221617528551, 0, 0, 0, 0, 0.0113610232076566,
0.0105494062637453, 0.0013677824519172, 0, 0, 0.00648259606341779,
0, 0.0214824890686964, 0.044124017744323, 0.0211872363121142,
0.014388372910949, 0.0169999010472842, 0.00301225821284707, 0.0259035488964498,
0.0107390744161216, 4.30472428485104e-11, 3.05023540602625e-11,
0.0122999680921261, 3.91713014845593e-11, 0.00140554877561418,
1.10720643843627e-12, 1.89183904985747e-11, 0.00623134039687322,
0.0184113109767503, 0, 0.0180951478406592, 0.0182921718350903,
1.53205750949292e-09, 0, 3.28957124490535e-10, 0.0243178871009045,
6.57585626955745e-09, 0.00120321600986535, 0.00629559105734284,
0.00643659676320839, 0, 0.000505140239946754, 0.0220273491266137,
0.00604209746062558, 0.0329834739695219, 0, 3.01964335567407e-09,
0.00292620788575339, 0.0104500338989523, 0.00865829152269329,
1.98889884897418e-09, 0.00336292169640687, 0.00763330301773366,
0.00627520022363156, 6.00269296232338e-11, 0.000541656331319956,
0.0176260340425435, 5.43693729445839e-12, 3.08266385476399e-11,
0.00557430910138088, 0.000784473579348263, 0.032007360230779,
0.0150893090380109, 0.0688031638860925, 0.00612029861726318,
0.018762716863953, 0.0288926541824658, 0.0337157845824907), f = c(0.02,
0.02, 0.02, 0, 0.02, 0, 0.02, 0.02, 0.04, 0, 0.02, 0, 0.02, 0,
0, 0, 0, 0, 0, 0.02, 0.02, 0, 0, 0.02, 0.02, 0, 0, 0, 0, 0.02,
0.02, 0.02, 0.02, 0, 0, 0.02, 0, 0, 0.02, 0, 0, 0, 0, 0, 0.02,
0, 0, 0, 0.06, 0.04, 0, 0, 0, 0.02, 0, 0, 0.02, 0.02, 0.02, 0,
0, 0, 0, 0, 0, 0.02, 0.02, 0.02, 0, 0, 0.02, 0, 0.02, 0, 0, 0.02,
0, 0, 0, 0, 0, 0, 0, 0.02, 0.02, 0, 0, 0, 0, 0, 0, 0.02, 0.02,
0.02, 0, 0, 0.02, 0.02, 0, 0, 0, 0, 0.02, 0, 0, 0, 0.02, 0, 0,
0.02, 0, 0, 0, 0, 0.02, 0.02, 0, 0, 0, 0.02, 0.02))


testthat::test_that('still same result on LifeCycleSavings',{
  testthat::expect_equivalent(x$a,x_ref$a)
  testthat::expect_equivalent(x$b,x_ref$b)
  testthat::expect_lt(sqrt(sum((x$p - x_ref$p)^2)), 1e-04)
  testthat::expect_equivalent(x$p,x_ref$p)
  testthat::expect_equivalent(x$f,x_ref$f)
  #testthat::expect_mapequal(x,x_ref)
})













